from kafka import KafkaProducer

producer = KafkaProducer(
    bootstrap_servers="localhost:9092",
    value_serializer=lambda v: json.dumps(v, default=str).encode('utf-8')
)


from kafka.admin import KafkaAdminClient, NewTopic

admin_client = KafkaAdminClient(bootstrap_servers="localhost:9092")

topic_list = [NewTopic(name="ventes_ecommerce", num_partitions=1, replication_factor=1)]
admin_client.create_topics(new_topics=topic_list, validate_only=False)
print("âœ… Topic crÃ©Ã© !")


from kafka.admin import KafkaAdminClient

admin_client = KafkaAdminClient(bootstrap_servers="localhost:9092")
print(admin_client.list_topics())


# send_to_kafka.py
import pandas as pd
from kafka import KafkaProducer
import json
import uuid

df = pd.read_csv("C:\\bigdataproject\\data\\online_retail.csv", sep=";", encoding="latin1")


# Nettoyage
df = df.dropna(subset=["CustomerID"])
df["InvoiceDate"] = pd.to_datetime(df["InvoiceDate"], errors='coerce')

df["Description"] = df["Description"].str.strip()

# Transformations
df["MontantTotal"] = df["Quantity"] * df["UnitPrice"]
df["Annulation"] = df["InvoiceNo"].astype(str).str.startswith("C")
df["Jour"] = df["InvoiceDate"].dt.day
df["Mois"] = df["InvoiceDate"].dt.month
df["Annee"] = df["InvoiceDate"].dt.year
df["Heure"] = df["InvoiceDate"].dt.hour
df["Country"] = df["Country"].replace({"United Kingdom": "UK"})
df["uuid"] = [str(uuid.uuid4()) for _ in range(len(df))]

producer = KafkaProducer(
    bootstrap_servers="localhost:9092",
    value_serializer=lambda v: json.dumps(v, default=str).encode('utf-8')
)

for _, row in df.iterrows():
    producer.send("ventes_ecommerce", row.to_dict())

producer.flush()
print("ðŸš€ Envoi terminÃ© dans Kafka !")
